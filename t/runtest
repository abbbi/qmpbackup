#!/bin/bash
set -e

IMAGE="https://chuangtzu.ftp.acc.umu.se/images/cloud/bullseye/latest/debian-11-genericcloud-amd64.qcow2"

exist_files() {
    if ! ls ${1} 1> /dev/null 2>&1; then
        echo "backup files do not exist"
        exit 1
    fi
}


echo "Downloading image"
[ ! -e /tmp/disk1.qcow2 ] && curl -L -s $IMAGE > /tmp/disk1.qcow2
[ ! -e /tmp/disk2.qcow2 ] && cp -f /tmp/disk1.qcow2 /tmp/disk2.qcow2

AGENT_SOCKET=/tmp/qga.sock
echo "Starting qemu process"
qemu-system-x86_64 -daemonize -display none -m 1024 \
    -hda /tmp/disk1.qcow2 \
    -hdb /tmp/disk2.qcow2 \
    -qmp unix:/tmp/socket,server,nowait \
    -chardev socket,path=$AGENT_SOCKET,server,nowait,id=qga0 \
    -device virtio-serial \
    -device "virtserialport,chardev=qga0,name=org.qemu.guest_agent.0" \


echo "give vm some time to spin up"
sleep 10

echo "------------------------------------------------"
echo "Executing qmpbackup tests"
echo "------------------------------------------------"
rm -rf /tmp/backup
../qmpbackup --agent-socket $AGENT_SOCKET --socket /tmp/socket backup --level full --target /tmp/backup/ --quisce

exist_files /tmp/backup//ide0-hd0/FULL* 
exist_files /tmp/backup//ide0-hd1/FULL* 

../qmpbackup --agent-socket $AGENT_SOCKET --socket /tmp/socket backup --level inc --target /tmp/backup/ --quisce
exist_files /tmp/backup//ide0-hd0/INC* 
exist_files /tmp/backup//ide0-hd1/INC* 
