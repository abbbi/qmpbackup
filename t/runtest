#!/bin/bash
set -e

IMAGE="https://app.vagrantup.com/generic/boxes/alpine38/versions/3.6.6/providers/libvirt.box"

exist_files() {
    if ! ls ${1} 1> /dev/null 2>&1; then
        echo "backup files do not exist"
        exit 1
    fi
}

rm -f /tmp/disk1.qcow2
rm -f /tmp/disk2.qcow2
rm -f /tmp/disk3.qcow2

echo "Downloading image"
[ ! -e /tmp/libvirt.box ] && curl -L -s $IMAGE > /tmp/libvirt.box
[ ! -e /tmp/box.img ] && tar -zxvf /tmp/libvirt.box box.img
mv -f box.img /tmp/disk1.qcow2
[ ! -e /tmp/disk2.qcow2 ] &&  qemu-img create -f qcow2 /tmp/disk2.qcow2 10M
[ ! -e /tmp/disk3.raw ] && qemu-img create -f raw /tmp/disk3.raw 10M

AGENT_SOCKET=/tmp/qga.sock
QMP_SOCKET=/tmp/socket
echo "Starting qemu process"
KVMOPT=""
[ -e /dev/kvm ] && KVMOPT="--enable-kvm" && echo "with kvm"
qemu-system-x86_64 $KVMOPT -smp $(nproc) -daemonize -display none -m 1024 \
    -hda /tmp/disk1.qcow2 \
    -hdb /tmp/disk2.qcow2 \
    -hdc /tmp/disk3.raw \
    -qmp unix:/tmp/socket,server,nowait \
    -chardev socket,path=$AGENT_SOCKET,server,nowait,id=qga0 \
    -device virtio-serial \
    -device "virtserialport,chardev=qga0,name=org.qemu.guest_agent.0" \
    -pidfile /tmp/qemu.pid

# wait until qemu agent is reachable within booted Vm, then continue
# with the tests
python3 -u agent.py

echo "------------------------------------------------"
echo "Executing qmpbackup tests"
echo "------------------------------------------------"
rm -rf /tmp/backup_no_agent
rm -f /tmp/backup.log
../qmpbackup --agent-socket /tmp/doenstexist --socket $QMP_SOCKET --logfile /tmp/backup.log backup --level full --exclude ide0-hd0 --target /tmp/backup_no_agent/ --quisce
[ -e /tmp/backup.log ]
grep Arguments /tmp/backup.log > /dev/null
grep INFO /tmp/backup.log > /dev/null

rm -rf /tmp/backup
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level full --target /tmp/backup/ --quisce

exist_files /tmp/backup//ide0-hd0/FULL* 
exist_files /tmp/backup//ide0-hd1/FULL* 

# create /tmp/incdata1 within the guest, execute further
# incremental backups
echo "------------------------------------------------"
python3 agent.py incdata1
echo "------------------------------------------------"

../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level inc --target /tmp/backup/ --quisce
exist_files /tmp/backup//ide0-hd0/INC* 
exist_files /tmp/backup//ide0-hd1/INC* 
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level auto --target /tmp/backup/ --quisce

rm -rf /tmp/monthly
../qmpbackup --socket $QMP_SOCKET backup --level auto --monthly --target /tmp/monthly/
exist_files /tmp/monthly/*/*/FULL*
../qmpbackup --socket $QMP_SOCKET backup --level auto --monthly --target /tmp/monthly/
exist_files /tmp/monthly/*/*/INC*

echo "------------------------------------------------"
echo "Executing common functionality  tests"
echo "------------------------------------------------"
# exclude/include
rm -rf /tmp/exclude
rm -rf /tmp/include
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level full --exclude ide0-hd0 --target /tmp/exclude/ --quisce
[ -e /tmp/exclude/ide0-hd0 ] && echo "backed up excluded disk" && exit 1
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level full --include ide0-hd1 --target /tmp/include/ --quisce
[ -e /tmp/exclude/ide0-hd0 ] && echo "backed up non included disks" && exit 1


echo "------------------------------------------------"
echo "Check bitmap information output"
echo "------------------------------------------------"


# at this point, block devices must show bitmaps
../qmpbackup --socket $QMP_SOCKET info --show blockdev | grep "qmpbackup-ide"
# bitmaps must be active
../qmpbackup --socket $QMP_SOCKET info --show bitmaps 2>&1 | grep "recording.*true"
# at least one bitmap must be removed at this point
../qmpbackup --socket $QMP_SOCKET cleanup --remove-bitmap 2>&1 | grep "Removing bitmap: qmpbackup-ide0-hd0"


# exit code of qmpbackup must be errnous if partial backup is found in directory
rm -rf /tmp/partial_backup
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level full --include ide0-hd1 --target /tmp/partial_backup/ --quisce
touch /tmp/partial_backup/ide0-hd1/FULL-bar.partial
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level inc --include ide0-hd1 --target /tmp/partial_backup/ --quisce && exit 1
../qmprebase rebase --dir /tmp/partial_backup/ide0-hd1/ --dry-run && exit 1

echo "------------------------------------------------"
echo "Executing qmprebase tests"
echo "------------------------------------------------"
rm -rf /tmp/restore
cp -a /tmp/backup/ /tmp/restore
../qmprebase rebase --dir /tmp/restore/ide0-hd0/ --dry-run
../qmprebase rebase --dir /tmp/restore/ide0-hd0/

echo "rollback OK"

echo "------------------------------------------------"
echo "Mounting rebased image"
echo "------------------------------------------------"
mkdir -p /tmp/empty
FILE=$(echo /tmp/restore/ide0-hd0/FULL*)
# for debugging
export LIBGUESTFS_DEBUG=1 LIBGUESTFS_TRACE=1
sudo -E guestmount -a $FILE /tmp/empty -i
# files created during incremental backup must exist after
# rebase
sudo stat /tmp/empty/tmp/incdata1/fstab >/dev/null
echo "Directory from incremental backup exists"
sudo -E guestunmount /tmp/empty

PID=$(cat /tmp/qemu.pid)
echo "killing qemu process: ${PID}"
kill -9 "${PID}"
