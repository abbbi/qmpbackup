#!/bin/bash
set -e

IMAGE="https://chuangtzu.ftp.acc.umu.se/images/cloud/bullseye/latest/debian-11-genericcloud-amd64.qcow2"

exist_files() {
    if ! ls ${1} 1> /dev/null 2>&1; then
        echo "backup files do not exist"
        exit 1
    fi
}


echo "Downloading image"
[ ! -e /tmp/disk1.qcow2 ] && curl -L -s $IMAGE > /tmp/disk1.qcow2
[ ! -e /tmp/disk2.qcow2 ] && cp -f /tmp/disk1.qcow2 /tmp/disk2.qcow2

[ ! -e /tmp/disk3.raw ] && qemu-img create -f raw /tmp/disk3.raw 10M

AGENT_SOCKET=/tmp/qga.sock
QMP_SOCKET=/tmp/socket
echo "Starting qemu process"
qemu-system-x86_64 -daemonize -display none -m 1024 \
    -hda /tmp/disk1.qcow2 \
    -hdb /tmp/disk2.qcow2 \
    -hdc /tmp/disk3.raw \
    -qmp unix:/tmp/socket,server,nowait \
    -chardev socket,path=$AGENT_SOCKET,server,nowait,id=qga0 \
    -device virtio-serial \
    -device "virtserialport,chardev=qga0,name=org.qemu.guest_agent.0" \
    -pidfile /tmp/qemu.pid


echo "give vm some time to spin up"
sleep 10

echo "------------------------------------------------"
echo "Executing qmpbackup tests"
echo "------------------------------------------------"
rm -rf /tmp/backup
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level full --target /tmp/backup/ --quisce

exist_files /tmp/backup//ide0-hd0/FULL* 
exist_files /tmp/backup//ide0-hd1/FULL* 

echo "wait some time between incremental and full backup"
sleep 10

../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level inc --target /tmp/backup/ --quisce
exist_files /tmp/backup//ide0-hd0/INC* 
exist_files /tmp/backup//ide0-hd1/INC* 
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level auto --target /tmp/backup/ --quisce

rm -rf /tmp/monthly
../qmpbackup --socket $QMP_SOCKET backup --level auto --monthly --target /tmp/monthly/
exist_files /tmp/monthly/*/*/FULL*
../qmpbackup --socket $QMP_SOCKET backup --level auto --monthly --target /tmp/monthly/
exist_files /tmp/monthly/*/*/INC*

../qmpbackup --socket $QMP_SOCKET info --show bitmaps
../qmpbackup --socket $QMP_SOCKET cleanup --remove-bitmap

echo "------------------------------------------------"
echo "Executing qmprebase tests"
echo "------------------------------------------------"
rm -rf /tmp/restore
cp -a /tmp/backup/ /tmp/restore
../qmprebase rebase --dir /tmp/restore/ide0-hd0/ --dry-run
../qmprebase rebase --dir /tmp/restore/ide0-hd0/

echo "------------------------------------------------"
echo "Mounting rebased image"
echo "------------------------------------------------"
mkdir -p /tmp/empty
FILE=$(echo /tmp/restore/ide0-hd0/FULL*)
# for debugging
#export LIBGUESTFS_DEBUG=1 LIBGUESTFS_TRACE=1
sudo -E guestmount -a $FILE /tmp/empty -i
sudo stat /tmp/empty/etc/fstab >/dev/null
sudo -E guestunmount /tmp/empty

echo "killing qemu process"
kill -9 "$(cat /tmp/qemu.pid)"
