#!/bin/bash
set -e

IMAGE="https://app.vagrantup.com/generic/boxes/alpine38/versions/3.6.6/providers/libvirt.box"

exist_files() {
    if ! ls ${1} 1> /dev/null 2>&1; then
        echo "backup files do not exist"
        exit 1
    fi
}

rm -f /tmp/disk1.qcow2
rm -f /tmp/disk2.qcow2
rm -f /tmp/disk3.qcow2

echo "Downloading image"
[ ! -e /tmp/libvirt.box ] && curl -L -s $IMAGE > /tmp/libvirt.box
[ ! -e /tmp/box.img ] && tar -zxvf /tmp/libvirt.box box.img
mv -f box.img /tmp/disk1.qcow2
[ ! -e /tmp/disk2.qcow2 ] && cp -f /tmp/disk1.qcow2 /tmp/disk2.qcow2
[ ! -e /tmp/disk3.raw ] && qemu-img create -f raw /tmp/disk3.raw 10M

AGENT_SOCKET=/tmp/qga.sock
QMP_SOCKET=/tmp/socket
echo "Starting qemu process"
qemu-system-x86_64 -daemonize -display none -m 1024 \
    -hda /tmp/disk1.qcow2 \
    -hdb /tmp/disk2.qcow2 \
    -hdc /tmp/disk3.raw \
    -qmp unix:/tmp/socket,server,nowait \
    -chardev socket,path=$AGENT_SOCKET,server,nowait,id=qga0 \
    -device virtio-serial \
    -device "virtserialport,chardev=qga0,name=org.qemu.guest_agent.0" \
    -pidfile /tmp/qemu.pid

# wait until qemu agent is reachable within booted Vm, then continue
# with the tests
python3 agent.py

echo "------------------------------------------------"
echo "Executing qmpbackup tests"
echo "------------------------------------------------"
rm -rf /tmp/backup
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level full --target /tmp/backup/ --quisce

exist_files /tmp/backup//ide0-hd0/FULL* 
exist_files /tmp/backup//ide0-hd1/FULL* 

# create /tmp/incdata1 within the guest, execute further
# incremental backups
echo "------------------------------------------------"
python3 agent.py incdata1
echo "------------------------------------------------"

../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level inc --target /tmp/backup/ --quisce
exist_files /tmp/backup//ide0-hd0/INC* 
exist_files /tmp/backup//ide0-hd1/INC* 
../qmpbackup --agent-socket $AGENT_SOCKET --socket $QMP_SOCKET backup --level auto --target /tmp/backup/ --quisce

rm -rf /tmp/monthly
../qmpbackup --socket $QMP_SOCKET backup --level auto --monthly --target /tmp/monthly/
exist_files /tmp/monthly/*/*/FULL*
../qmpbackup --socket $QMP_SOCKET backup --level auto --monthly --target /tmp/monthly/
exist_files /tmp/monthly/*/*/INC*

../qmpbackup --socket $QMP_SOCKET info --show bitmaps
../qmpbackup --socket $QMP_SOCKET cleanup --remove-bitmap

echo "------------------------------------------------"
echo "Executing qmprebase tests"
echo "------------------------------------------------"
rm -rf /tmp/restore
cp -a /tmp/backup/ /tmp/restore
../qmprebase rebase --dir /tmp/restore/ide0-hd0/ --dry-run
../qmprebase rebase --dir /tmp/restore/ide0-hd0/

echo "------------------------------------------------"
echo "Mounting rebased image"
echo "------------------------------------------------"
mkdir -p /tmp/empty
FILE=$(echo /tmp/restore/ide0-hd0/FULL*)
# for debugging
#export LIBGUESTFS_DEBUG=1 LIBGUESTFS_TRACE=1
sudo -E guestmount -a $FILE /tmp/empty -i
exit 0
# files created during incremental backup must exist after
# rebase
sudo stat /tmp/empty/tmp/incdata1/fstab >/dev/null
sudo -E guestunmount /tmp/empty

echo "killing qemu process"
kill -9 "$(cat /tmp/qemu.pid)"
